# 操作系统第五章——存储管理
[TOC]

## 计算机存储体系结构

速度降低，容量加大，价格降低：
1. 寄存器
2. 缓存
3. 主存
4. 磁盘
5. 磁带

存储管理目的：
- 方便使用者
- 有效利用存储资源，提高系统效率

## 地址重定位

当程序被装入内存时，逻辑地址->物理地址

地址重定位技术
- 绝对装入/固定地址再定位
  - 编译时直接生成物理地址
- 可重定位装入
  - 装入内存时逻辑地址和物理地址不一致
  - 静态再定位：程序执行之前进行地址再定位
  - 动态再定位：在访问物理内存之前，实时将逻辑地址转换为物理地址。

## 存储管理方案

- 分区存储管理
- 页式存储管理方案
- 段式存储管理方案
- 段页式存储管理方案
- 交换和覆盖技术
- 虚拟存储管理方案

### 分区存储管理方案：连续分配存储空间
- 单一连续分区存储管理：内存中一次只能装入一个用户程序，独占整个用户区
- 固定分区管理：每个分区大小固定，单不一定一样
  - 分区状态表
- 可变分区管理：预先不划分内存，作业要装载时向系统请求分配
- 分区分配算法：
  - 最先适用算法：将空闲分区按地址递增排序
  - 下次适应算法（循环最先适应算法）：从上次分配的分区起，
  - 最佳适应算法：将空闲区按容量递增顺序排列
  - 最坏适应算法：将空闲区按容量递减顺序排列
  - 可再定位式分区（浮动分区分配）：移动所有被分配的分区，使之成为一个连续区域，留下较大空白区
### 页式存储管理方案
- 将虚拟地址空间分为若干个长度相等的页->虚页；主存也划分为页->实页。要求作业运行前将虚页全部装入主存的块中。
- ![20220228204858-2022-02-28-20-48-58](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220228204858-2022-02-28-20-48-58.png)
- 数据结构：进程页表（逻辑页号到物理页号的映射），物理页表（物理内存空间的分配使用情况），请求表（描述系统内各个进程表的位置和大小）
- 一次请求数据（指令）需要访问内存两次：一次页表，一次数据（指令）
- 计算物理地址：拼接
### 段式存储管理方案
- 作业必须一次性装入，否则称为请求分段式。
- 以模块为单位存储
- 实现分段保护、动态链接
- 数据结构：进程段表（变换表），系统段表（系统锁占有的段），空闲段表（内存中所有空闲段）
- 计算物理地址：相加

> |                          分页                          |                             分段                             |
> | :----------------------------------------------------: | :----------------------------------------------------------: |
> |                      出于系统需要                      |                      出于用户应用的需要                      |
> |                      大小系统固定                      |                        大小通常不固定                        |
> | 逻辑地址上是一维的：各个模块在链接时组织在一个地址空间 | 逻辑地址上是二维的：各个模块链接时吧每个段组织成一个地址空间 |
> |                                                        |                    段比页大，段表比页表短                    |
> |                    不能实现内存共享                    |                       可以实现内存共享                       |
### 段页式存储管理方案
- 程序分段，段内分页
- 即将程序按段划分，将物理内存按页划分
- 数据结构：段表（页表起始地址和页表长度），页表（段对应的逻辑地址与内存块号的对应关系，每一段有一个页表），空闲内存页表，物理内存分配
### 交换和覆盖技术

>内存扩充：在基本的存储管理系统中，当一个作业的程序地址空间大于内存可以使用的空间时，该作业就不能装入运行，并发运行进程数受到了内存空间的限制。借助大容量的辅存在逻辑上扩充内存。

- 覆盖技术：程序模块之间
- 交换技术：交换单位是整个进程的地址空间
### 虚拟存储管理方案
- 程序执行规律
  - 程序中不是每一条指令都会在一次运行过程中执行到
  - 程序中有点指令可能只执行一次
  - 局部性原理
    - 时间局部性：一段程序是在一段时间内被使用
    - 空间局部性：当前指令和临近的几条指令、当前访问的数据和临近的数据都集中在一个较小区域内
- 虚拟存储：大容量磁盘作为后备，用来暂时不适用的部分作业。通过缺页（缺段）中断调入内存。调出到外存，是请求调入和置换功能，对于动态链接库也可以请求调入。
- 虚拟页式存储管理
  - 页面淘汰算法
    - 先进先出（FIFO）
    - 最近最少使用（LRU）
    - 最佳算法
    - 第二次机会淘汰算法
    - 页面缓冲算法
> Belady现象：可用页面数增大，缺页率反而升高。
  - 功能分析：
    - 颠簸、抖动现象
      - 页面淘汰算法不合理
      - 分配给进程的物理页面数太少
    - 常驻集
      - 常驻集是指在当前时刻，进程实际驻留在内存当中的页面集合
    - 工作集
      - 对于给定的访问序列选取定长的区间，称为工作集窗口
      - 落在工作集窗口中的页面集合称为至作集