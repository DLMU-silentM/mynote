# 操作系统第六章——文件管理
[TOC]

管理文件在外存上，即磁盘上是如何存储的。

## 文件

记录在外存上的，既有符号名的，在逻辑上具有完整意义的一组相关信息的集合

用户角度看，文件是逻辑外存的最小分配单元

文件组成：
- 文件体
- 文件说明
  - 文件名称
  - 文件内标识符
  - 文件类型
    - 文件后缀
    - 文件性质和用途
      - 系统文件
      - 库文件
      - 用户文件
    - 保存期限
      - 临时文件
      - 档案文件
      - 永久文件
    - 保护方式
      - 只读文件
      - 读写文件
      - 可执行文件
      - 不保护文件
  - 文件存储位置
  - 文件大小
  - 访问权限
  - 时间，日期，用户标识

## 文件结构

### 逻辑结构：

用户观察到的文件组织形式

- 有结构的记录式文件：由一个以上的记录构成
  - 定长的
  - 变长的
- 无结构的流式文件：文件没有结构，由一串字符流构成

### 物理结构：

文件内部的组织形式，在物理存储设备上的存放方法

- 连续存储（顺序结构）
  - 将逻辑上来连续的文件信息一次存放在编号连续的物理块上
- 链接结构
  - 将逻辑上连续的文件信息存放在不连续的物理块上，每个物理块设有一个指针指向下一个物理块。
- 索引结构
  - 将逻辑上连续的文件信息（记录）存放在不连续的物理块中，系统为每个文件建立一个专用数据绩构--索引表，索引表中存放文件的逻辑块号和物理块号的对应关系。
  - 索引表的组织方式：
    - 链接文件方式：将多个索引块按链接文件的方式串联起来
    - 多重索引方式：用索引表来索引索引表
  - Hash文件
    - 采用计算寻址结构，由主文件和溢出文件组成。

### 文件的存取方式：

- 顺序读取
- 随机读取
  - 直接存取法
  - 按键存取法

## 文件的目录

分类：
- 一级目录
- 二级目录
- 多级目录
- UNIX文件目录
  ![20220302160908-2022-03-02-16-09-09](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220302160908-2022-03-02-16-09-09.png)

## 文件目录的操作
- 打开文件机构
  - 操作系统在内存设置了一个非常精炼的文件机构，它不是外存文件管理机构的全部映象，而是存储最近正在使用文件的相关信息。文件打开后由内存的一套管理机构管理，关闭时退出管理机构，所以将这种文件管理机构称为打开文件机构。
  - 结构：
    - 内存文件控制块
      - 使用外存内容时，将它调入内存文件控制块
    - 系统打开文件表
      - 每个打开文件对应一个指针，系统打开文件表存放已打开的文件信息
    - 用户打开文件表
      - 进程打开文件时，填入打开文件控制块结构变量的地址，打开文件描述字的值。

## 外存空间管理

### 空闲区表

外存上连续未分配的区域称为“空闲区”。每个表对应一个空闲区。

分配：查表，取区，修改表项。

删除：填入空闲表项，试图合并。

### 位视图

在外存上建立位试图。每一位对应文件存储器上的一个物理块。

### 空闲块链

每个空闲物理块有指向下一个空闲块的指针。

### 成组链接法

将空闲块分成若干组，没100个空闲块未一组，每组第一个空闲块保存了下一组空闲块的物理盘块号和本组空闲块总数。

设置了一个专用块，类似于链表的头节点，用于指示第一组的空闲盘块号

释放：

![20220302203512-2022-03-02-20-35-13](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220302203512-2022-03-02-20-35-13.png)

分配：

![20220302203535-2022-03-02-20-35-35](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220302203535-2022-03-02-20-35-35.png)

## 文件共享

不同用户或进程使用同一个文件，实际上文件的实体只有一个。

UNIX文件系统中，文件名（目录项）和文件说明时分离的，有利于实现共享

静态共享：一个文件同时属于多个文件目录项，但实际上仅仅只有一处物理存储。多个文件目录项对应一个文件实体的多对一关系称为文件链接。

静态共享实现：
- 硬链接
- 软链接（符号链接）：符号链接文件的内容为被链接文件的路径名

动态共享：出现在进程共享文件时，伴随着进程的生成而存在，进程的终止，而消失。

## 文件系统性能问题

### 磁盘调度

磁盘是一种共享设备，每一时刻只允许一个进程启动磁盘进行I/O操作，其余的进程只能等待。

设置调度算法的目标：使各进程对磁盘的平均访问时间最小。

- 寻道时间
- 旋转延迟时间
- 数据传输时间

磁盘调度：
1. 移臂调度
2. 旋转调度

访问磁盘最耗时的时寻道。

磁盘调度（移臂调度）算法：
- 先来先服务：严格按照进程请求访问磁盘的先后次序进行调度
- 最短寻道时间优先算法：要求每次访问的磁道与当前磁头所在的磁道距离最近（可能出现“饥饿”现象）
- 电梯调度算法（SCAN）：不仅考虑到预访问的磁道与当前磁道的距离，更优先考虑磁头的当前移动方向。
- 循环扫描调度（CSCAN）：规定磁头只能单向移动

旋转调度算法：
1. 进程请求访问的是同一磁道上的不同编号的扇区
2. 进程请求访问的是不同磁道上的不同编号的扇区
3. 进程请求访问的是不同磁道上具有相同编号的扇区
- 对于（1）和（2），旋转调度总是让首先到达读写磁头位置下的扇区先进行传送操作
- 对于（3），旋转调度可以任选一个读写磁头位置下的扇区进行传送操作。
- 目标：在同一柱面读写信息时）花费最少的时间。
- 例：
  
  ![20220302211527-2022-03-02-21-15-28](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220302211527-2022-03-02-21-15-28.png)

信息优化分布：合理安排数据存储位置