# 操作系统第三章-进程管理

[TOC]

## 进程

- 早期：单道环境——顺序执行
- 现在：多道环境——并发执行

### 定义

进展中的程序：进程=程序+执行。进程是程序的一次执行，该进程可与其它进程并发执行；它是个动态的实体，在传统的操作系统设计中，进程既是资源的基本分配单元（也是基本的执行单元）。在现代多线程操作系统中，线程式基本的执行单元，进程式资源的基本分配单元。

|   程序   |           进程           |
| :------: | :----------------------: |
|   静态   |           动态           |
|   永久   |           暂时           |
|          | 资源分配和保护的基本单位 |
| 结构不同 |         结构不同         |
|          | 一个进程可以包括多个程序 |

### 组成

- 进程控制块PCB
  - **进程的描述和控制信息，进程存在的唯一标志**：身份证号
  - 进程的档案：史书
  - 提供各种信息，以供操作系统查询，控制和管理
- 程序
- 数据
- 工作区

### 基本状态基本状态及其转换

- 就绪态
  - 只差处理机执行（没CPU）
- 运行态
  - 占有处理机，正在执行
- 阻塞态（等待，挂起，睡眠）
  - 因等待某种条件无法运行（没CPU，没资源）

![20220226214611-2022-02-26-21-46-12](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220226214611-2022-02-26-21-46-12.png)

- 运行->阻塞：主动
- 阻塞->就绪：被动
- 新建->就绪：创建成功即就绪

> 原语：计算机进程控制使用原语完成，在执行过程中不可被中断。

### 执行与控制

组织管理：队列

- 就绪队列

- 等待队列
  
  <img src="http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220226215213-2022-02-26-21-52-14.png" title="" alt="20220226215213-2022-02-26-21-52-14" width="317">

进程控制：原语（“原子操作”过程）

- 进程控制原语
- 进程通讯原语
- 资源管理原语
- 其他

### 特征

- 并发性
- 动态性
- 独立性：独立执行
- 制约性：可能等待其他进程的结果
- 异步性：执行时间相对独立
- 结构性：每个进程都有固定结构

## 进程调度

按照一定算法从就绪队列中选择某个进程进入CPU

安全，高效

- 先来先服务（FCFS）
- 基于优先级的调度算法（Priority Scheduling Aligorthm）
  - 静态优先算法
  - 动态有限算法：
    - 如高相应比优先算法：相应比=等待时间+运行时间/运行时间
- 时间片轮转法
  - 专为分时系统设计，公平，对用户反应及时
  - 按到达顺序，轮流让各个进程执行一个时间片
  - 固定时间片
  - 可变时间片
  - 若时间片过长，每个进程都能在一个时间片内完成，则退化为先来先服务算法；若时间片过短，则上下文切换过于频繁
  - 选择时间片因素：
    - 系统响应时间
    - 就绪进程个数
    - CPU能力
- 多级反馈队列调度算法
  - 引入多个就绪队列，通过对各队列的区别对待，达到一个综合的调度目标
    - 队列优先级越低，单次分配的时间片数越多。
    - 一个较高优先级进程用完分配的时间片后，被移入下一级队列中，当本级队列空才会调用较低优先级队列。
    - 若执行时有新进程进入较高优先级，则抢占当前较低优先级进程（使用中断进行）

## 进程间相互作用

### 同步互斥

进程间相互合作、协同的关系称为“同步”。一种直接的制约关系，制约多个进程的执行次序。

临界资源：在一段时间只允许一个进程访问的资源。也可以是进程共享的数据、变量等。

多个进程因争夺临界资源产生的互斥称为进程的“互斥”，是一种间接的制约关系。

锁变量法：设置共享变量W（锁），初值为1，一个程序向进入临界区（设置临界资源的程序段），若W为0，进入并将W置为1；若为1，等到直到变为0。
- 加锁：LOCK(W)
  ```
  L:
  if W=1
  then goto L
  else W=1;
  ```
- 解锁：UNLOCK(W)
  ```
  W=0;
  ```
- ```
  LOCK(W)
  临界区
  UNLOCK(W)
  ```

### 信号量和P，V操作
- IPC：进程见通信
- 表示资源的实体，是一个与队列有关的整形变量
- 其值只能通过初始化操作和P、V操作来访问
- 信号量类型：
  - 共有信号量：用于互斥，初值1
  - 私有信号量：用于同步，初值0或n
- P操作（wait）：检测，请求分配一个资源。是一个原语操作
  
  P(S)：S为信号量，S表示资源的数量。
  ```
  {
    S=S-1
    if(S<0)
    {
      调用进程被阻塞，进入S的等待队列
    }
  }
  ```
- V操作（single）：增量，释放一个单位资源。是一个原语操作
  ```
  {
    S=S+1
    if(S>0)
    {
      从S的等待队列中唤醒一个进程，使其进入就绪态
    }
  }
  ```

#### 读者写者问题

<img src="http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220227150550-2022-02-27-15-05-50.png" title="" alt="20220227150550-2022-02-27-15-05-50" width="480">

#### 理发师问题

![20220227162600-2022-02-27-16-26-00](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220227162600-2022-02-27-16-26-00.png)

#### 管程

信号量机制解决了进程同步问题，但是分散在各个进程中不便于管理，使用不当可能造成死锁。Dijkstra提出秘书进程（管程）概念用于是心啊诸进程对同一临界资源的互斥使用。

相当于一个“类”

特点
- 局部于管程的数据只能被局部于管程的函数所访问
- 一个进程只有通过调用管程内的函数才能进入管程访问共享数据
- 每次仅允许一个进程在管程内执行某个函数
- 管程的互斥访问完全由编译程序在编译时自动添加，保证正确
- 把PV操作封装起来直接调用

## 进程通信
通信方式分类：
- 直接通信：信息直接传递给接收方
- 间接通信：借助收发双方进程之外的共享数据结构作为通信中转

交换信息量多少和效率高低
- 低级通信：只能传递状态和整数值，传递信息量小
- 高级通信
  - 共享内存
    - CreateFileMapping()：函数创建一个内存映射文件对象
    - MapViewOfFile()：将文件映射对象的视图映射进地址空间
    - memcpy()：数据复制到共享内存
    - OpenFileMapping()：打开一个命名的共享文件对象
  - 消息传递
    - 包括消息头和消息体
    - 直接通信（点对点）：
      - Send (DestProcessName, Message);
      - Receive (SourceProcessName, Message);
    - 间接通信（信箱方式）：
      - Send (MailBox, Message);
      - Receive (MailBox, Message);
  - 共享文件
    - 管道：基于文件系统，来凝结两个进程，以FIFO方式单项传递数据
      - 匿名管道：本地，非网络
      - 命名管道：同计算机的不同进程间，不同计算机的进程间

### 线程

轻量级进程，时现代操作系统中处理机调度（执行）的基本单位

所有线程拥有相同的代码段，不同的线程可以执行相同或不同的代码段

线程可以独立运行，也可以相互合作

每个线程拥有独立的上下文

- 用户级线程
  - 由应用程序管理线程
  - 核心感受不到线程存在
- 核心级线程（内核线程）
  - 通过核心来管理