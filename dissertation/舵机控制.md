# 舵机控制

## 参考文章
[《舵机控制基本原理》](https://blog.csdn.net/smartvxworks/article/details/107831572?ops_request_misc=&request_id=&biz_id=102&utm_term=%E8%88%B5%E6%9C%BA%E6%8E%A7%E5%88%B6&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-5-107831572.nonecase&spm=1018.2226.3001.4187)

[第9章 舵机控制](https://blog.csdn.net/u011878611/article/details/109757325?ops_request_misc=&request_id=&biz_id=102&utm_term=%E8%88%B5%E6%9C%BA%E6%8E%A7%E5%88%B6&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-109757325.nonecase&spm=1018.2226.3001.4187)

[舵机的控制原理](https://blog.csdn.net/weixin_49452698/article/details/114043324?ops_request_misc=&request_id=&biz_id=102&utm_term=%E8%88%B5%E6%9C%BA%E6%8E%A7%E5%88%B6&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-2-114043324.nonecase&spm=1018.2226.3001.4187)

[舵机控制 —— 一篇就够](https://blog.csdn.net/qq_51272949/article/details/120228587?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_utm_term~default-0.pc_relevant_default&spm=1001.2101.3001.4242.1&utm_relevant_index=2)

[STM32控制舵机讲解，从入门到放弃。](https://blog.csdn.net/qq_42866708/article/details/113355329?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165037531916782246437893%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=165037531916782246437893&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-2-113355329.142^v9^control,157^v4^new_style&utm_term=%E8%88%B5%E6%9C%BA%E6%8E%A7%E5%88%B6&spm=1018.2226.3001.4187)

## 基础

### 舵机概念及组成

舵机：**伺服电机**通常被称为舵机，它是一种带有**输出轴**的小装置。当我们向伺服器发送一个控制信号时，输出轴就可以转到特定的位置。只要控制信号持续不变，伺服机构就会保持轴的角度位置不改变。如果控制信号发生变化，输出轴的位置也会相应发生变化。

![20220419160039-2022-04-19-16-00-41](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220419160039-2022-04-19-16-00-41.png)

其中角度传感器负责舵机的位置反馈，直接装在舵机的主输出轴上，将轴旋转后产生的角度变化变成电压信号发回控制电路；

控制驱动电路：接收**外部接口传来的信号**和**角度传感器反馈的电压值**，以及驱动直流电机旋转；

减速齿轮组则是**降低直流电机的转速并且放大扭矩**；

市面上常见的廉价舵机通常采用小型的直流有刷电机和塑料材质减速齿轮组，传感器一般使用电位器返回模拟电压；而一些稍贵的则会使用金属齿轮组，一些高端的舵机内部甚至会采用无刷电机和磁电编码器。

### 舵机分类

1. 按照舵机的控制电路可以分为：模拟舵机和数字舵机。模拟舵机和数字舵机的机械结构可以说是完全相同的，**模拟舵机的控制电路为纯模拟电路**，需要一直发送目标信号，才能转到指定的位置，响应速度较慢，无反应区较大；**数字舵机内部控制电路则加上了微控制器**，只需要发送一次目标信号，即可到达指定位置，速度比模拟舵机更快，无反应区也更小。

2. 按照使用对象的不同，可以分为：航模舵机、车模舵机、船模舵机和机器人舵机。航模舵机一般要求速度快、精度高，而车模和船模用的舵机一般要求具有大扭矩和防水性好。

3. 按照内部机械材质，又可分成：塑料齿舵机和金属齿舵机。塑料齿舵机内部的传动齿轮是塑料的，重量轻价格便宜，扭矩一般较小无法做大；金属齿舵机的扭矩大，舵机更结实耐用，但是相比塑料齿更重也更贵。
   
4. 按照外部接口和舵机的控制方式，又可分为：PWM 舵机和串行总线舵机。


## 舵机工作原理

舵机内部的控制电路，电位计（可变电阻器）和电机均被连接到电路板上。控制电路通过电位计可监控舵机的当前角度。

模拟舵机和数字舵机内部电路不同，所以原理上稍有差别，这里以模拟舵机进行讲解。**模拟舵机内部的控制驱动电路板从外界接收控制信号，经过处理后变为一个直流偏置电压**，在控制板内部有一个基准电压，这个基准电压由电位器产生,将外部获得的直流偏置电压与电位器的电压进行比较获得电压差，并输出到电机驱动芯片驱动电机，电压差的正负决定电机的正反转，大小决定旋转的角度，电压差为0 时，电机停止转动。

舵机角度根据制造商的不同而有所不同。比如，一个180度的舵机，它可以在0度至180度之间运动。由于**限位装置被安装在主输出装置上**，超出这个范围机械结构就不能再转动了。

舵机的输出功率与它所需要转动的距离成正比。如果输出轴需要转动很长的距离，马达就会全速运转，如果它只需要短距离转动，马达就会以较慢的速度运行，这叫做**速度比例控制**。

大致原理图：

![20220419160327-2022-04-19-16-03-29](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220419160327-2022-04-19-16-03-29.png)

从图中可以看到，舵机内部是**闭环控制**的，所以这一类电机实际上是一种位置（角度）伺服的简化版伺服电机，将工业伺服电机的三闭环控制简化成了只有一个位置闭环。舵机这个名字是国内起的一种俗称，本质上属于伺服电机，它的英文就直接叫Servo，或者RC Servo。

## 舵机控制原理

### PWM信号

PWM，英文名Pulse Width Modulation，是脉冲宽度调制缩写，它是通过对一系列脉冲的宽度进行调制，等效出所需要的波形（包含形状以及幅值），对模拟信号电平进行数字编码，也就是说通过调节占空比的变化来调节信号、能量等的变化，占空比就是指在一个周期内，信号处于高电平的时间占据整个信号周期的百分比，例如方波的占空比就是50%。

#### PWM的频率：

 是指1秒钟内信号从高电平到低电平再回到高电平的次数(一个周期)；

也就是说一秒钟PWM有多少个周期

单位： Hz

表示方式： 50Hz 100Hz

#### PWM的周期：

T=1/f

周期=1/频率

50Hz = 20ms 一个周期

如果频率为50Hz ，也就是说一个周期是20ms 那么一秒钟就有 50次PWM周期

#### PWM占空比:

是指在一个周期内，信号处于高电平的时间占据整个信号周期的百分比，由于PWM周期为20ms，所以（以舵机会转动 45°为例），占空比就应该为1ms/20ms = 5%，所以TIM_SetCompare1的 TIMx 捕获比较 1 寄存器值就为200-200*5% = 190

单位： % (0%-100%)

表示方式：20%

### PWM信号控制舵机角度

**利用占空比的变化改变舵机的位置**

控制线用于传输角度控制信号。这个**角度是由控制信号脉冲的持续时间决定的**，这叫做**脉冲编码调制（PCM）**。舵机的控制一般需要一个20ms左右的时基脉冲，该脉冲的高电平部分一般为0.5ms-2.5ms范围，总间隔为2ms。脉冲的宽度将决定马达转动的距离。例如：1.5毫秒的脉冲，电机将转向90度的位置（通常称为中立位置，对于180°舵机来说，就是90°位置）。如果脉冲宽度小于1.5毫秒，那么电机轴向朝向0度方向。如果脉冲宽度大于1.5毫秒，轴向就朝向180度方向。以180度舵机为例，对应的控制关系是这样的：

|脉冲宽度|轴向|
|:-:|:-:|
|0.5ms|0度|
|1.0ms|45度|
|1.5ms|90度|
|2.0ms|135度|
|2.5ms|180度|

### 单片机实现舵机转角控制

> 可以使用FPGA、模拟电路、单片机来产生舵机的控制信号，但FPGA成本高且电路复杂。对于脉宽调制信号的脉宽变换，常用的一种方法是采用调制信号获取有源滤波后的直流电压，但是需要50Hz(周期是20ms)的信号，这对运放器件的选择有较高要求，从电路体积和功耗考虑也不易采用。5mV以上的控制电压的变化就会引起舵机的抖动，对于机载的测控系统而言，电源和其他器件的信号噪声都远大于5mV，所以滤波电路的精度难以达到舵机的控制精度要求。
>
> 也可以用单片机作为舵机的控制单元，使PWM信号的脉冲宽度实现微秒级的变化，从而提高舵机的转角精度。单片机完成控制算法，再将计算结果转化为PWM信号输出到舵机，由于单片机系统是一个数字系统，其控制信号的变化完全依靠硬件计数，所以受外界干扰较小，整个系统工作可靠。

单片机系统实现对舵机输出转角的控制，必须首先完成两个任务：首先是产生基本的PWM周期信号，本设计是产生20ms的周期信号；其次是脉宽的调整，即单片机模拟PWM信号的输出，并且调整占空比。

当系统中只需要实现一个舵机的控制，采用的控制方式是改变单片机的一个定时器中断的初值，将20ms分为两次中断执行，一次短定时中断和一次长定时中断。这样既节省了硬件电路，也减少了软件开销，控制系统工作效率和控制精度都很高。

具体的设计过程：例如想让舵机转向左极限的角度（0°），它的正脉冲为0.5ms，则负脉冲为20ms-0.5ms=19.5ms，所以开始时在控制口发送高电平，然后设置定时器在0.5ms后发生中断，中断发生后，在中断程序里将控制口改为低电平，并将中断时间改为19.5ms，再过19.5ms进入下一次定时中断，再将控制口改为高电平，并将定时器初值改为0.5ms，等待下次中断到来，如此往复实现PWM信号输出到舵机。用修改定时器中断初值的方法巧妙形成了脉冲信号，调整时间段的宽度便可使伺服机灵活运动。

为保证软件在定时中断里采集其他信号，并且使发生PWM信号的程序不影响中断程序的运行(如果这些程序所占用时间过长，有可能会发生中断程序还未结束，下次中断又到来的后果)，所以需要将采集信号的函数放在长定时中断过程中执行，也就是说每经过两次中断执行一次这些程序，执行的周期还是20ms。

如果系统中需要控制几个舵机的准确转动，可以用单片机和计数器进行脉冲计数产生PWM信号。

> 脉冲计数可以利用51单片机的内部计数器来实现，但是从软件系统的稳定性和程序结构的合理性看，宜使用外部的计数器，还可以提高CPU的工作效率。实验后从精度上考虑，对于FUTABA系列的接收机，当采用1MHz的外部晶振时，其控制电压幅值的变化为0.6mV，而且不会出现误差积累，可以满足控制舵机的要求。最后考虑数字系统的离散误差，经估算误差的范围在±0.3%内，所以采用单片机和8253、8254这样的计数器芯片的PWM信号产生电路是可靠的。

当系统的主要工作任务就是控制多舵机的工作，并且使用的舵机工作周期均为20ms时，要求硬件产生的多路PWM波的周期也相同。使用51单片机的内部定时器产生脉冲计数，一般工作正脉冲宽度小于周期的1/8，这样可以在1个周期内分时启动各路PWM波的上升沿，再利用定时器中断T0确定各路PWM波的输出宽度，定时器中断T1控制20ms的基准时间。

第1次定时器中断T0按20ms的 1/8设置初值，并设置输出I/O口，第1次T0定时中断响应后，将当前输出I/O口对应的引脚输出置高电平，设置该路输出正脉冲宽度，并启动第2次定时器中断，输出I/O口指向下一个输出口。第2次定时器定时时间结束后，将当前输出引脚置低电平，设置此中断周期为20ms的1/8减去正脉冲的时间，此路PWM信号在该周期中输出完毕，往复输出。在每次循环的第16次(2×8=16)中断实行关定时中断T0的操作，最后就可以实现8路舵机控制信号的输出。

![20220419182552-2022-04-19-18-25-52](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220419182552-2022-04-19-18-25-52.png)

也可以采用外部计数器进行多路舵机的控制，但是因为常见的8253、8254芯片都只有3个计数器，所以当系统需要产生多路PWM信号时，使用上述方法可以减少电路，降低成本，也可以达到较高的精度。调试时注意到由于程序中脉冲宽度的调整是靠调整定时器的初值，中断程序也被分成了8个状态周期，并且需要严格的周期循环，而且运行其他中断程序代码的时间需要严格把握。

在实际应用中，采用51单片机简单方便地实现了舵机控制需要的PWM信号。对机器人舵机控制的测试表明，舵机控制系统工作稳定，PWM占空比 (0.5～2.5ms 的正脉冲宽度)和舵机的转角(-90°～90°)线性度较好。


## 性能参数

**舵机速度**的单位是sec/60°，就是舵机转过60° 需要的时间，如果控制脉冲变化宽度大，变化速度快，舵机就有可能在一次脉冲的变化过程中还没有转到目标角度时，而脉冲就再次发生了变化，舵机的转动速度一般有0.16sec/60°、0.12sec/60° 等，0.16sec/60° 就是舵机转动60° 需要0.16 秒的时间。旋转停留时间大于240ms/90度

舵机的速度还有工作电压有关，在允许的电压范围内，电压越大速度越快，反之亦然。

**舵机扭矩**的单位是KG*CM，这是一个扭矩的单位，可以理解为在舵盘上距离舵机轴中心水平距离1CM 处，舵机能够带动的物体重量，如下图所示。

一个舵机参数：

![20220419161559-2022-04-19-16-16-01](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220419161559-2022-04-19-16-16-01.png)

## 代码设计

```
#include <regx51.h>
 
sbit PWM=P1^1;  //定义给舵机信号线接的I/O口
 
void Delay(unsigned char i)   //12MHz 延时函数  
{
    unsigned char a,b;        //该段延时函数Delay(1)=0.5ms
    for(;i>0;i--)
      for(b=71;b>0;b--)
        for(a=2;a>0;a--);
}
 
/****************************************************************
                            总周期20ms
                通过调节占空比实现舵机需要转动的角度
舵机代码用定时器控制更方便稳定，本文方便读者了解使用，使用延时计算
                         其功能可正常使用
*****************************************************************/
void zero(void) //0度 子程序
{   
        PWM=1;
        Delay(1);       //高电平 Delay(1)=0.5ms。因为周期为20ms，所以低电平就是19.5ms 
        PWM=0;
        Delay(39);      //低电平 Delay(39)=19.5ms
}
 
void one(void) //45度 子程序
{
        PWM=1;
        Delay(2);      //高电平  Delay(2)=1ms
        PWM=0;   
        Delay(38);     //低电平  Delay(38)=19ms
}
 
void two(void)  //90度 子程序
{
         PWM=1;
        Delay(3);       //高电平 Delay(3)=1.5ms
        PWM=0;
        Delay(37);     //低电平  18.5ms
}
 
void three(void) //135度 子程序
{
        PWM=1;
        Delay(4);       //高电平 Delay(4)=2ms
        PWM=0;
        Delay(36);      //低电平 18ms
}
 
void four(void) //180度 子程序
{
        PWM=1;
        Delay(5);      //高电平 Delay(5)=2.5ms
        PWM=0;
        Delay(35);     //低电平 17.5ms
}
 
 
void main()  //主程序
{     
    while(1)
    {    
         two();     //调用90度的子程序，实现舵机转动90度
    }
}
 
//end
```

如果需要按键控制，可以通过改变主程序代码实现，如↓ 

```
void main()
{     
	while(1)
	{	
         if(P3_1==0)   //按键接P3^1口。如果按键按下
		{
		  /* Delay(20);   //10ms的按键消抖，可删，看需要添加。
			 if(P3_1==0)    */
             two();  //如果按键按下，调用舵机90度子程序，实现转动90度。			 
		}
 
		 else         //否则
		    zero();   //舵机为0度
    }
}
```

> 12MHz 晶振的延时函数
> 
> > ```
> > //延时n毫秒
> > void delay_ms(unsigned int n)
> > {
> >     unsigned int i=0,j=0;
> >     for(i=0;i<n;i++)
> >         for(j=0;j<123;j++);
> > }
> > 
> > //延时n秒
> > void delay_m(unsigned int n)
> > {
> >     unsigned int i=0,j=0;
> >     for(i=0;i<n;i++)
> >         for(j=0;j<21738;j++);
> > }
> > 
> > //延时10*n微秒
> > void delay_10um(unsigned int n)
> > {
> >     while(n--);
> > }
> > ```

## Arduino UNO 控制舵机

### 硬件

-  1 × Arduino UNO

- 1 × 舵机

- 1 × ULN2003 驱动IC（用于防止直接通过Arduino驱动舵机造成问题）

- 1 × 10 KΩ 电阻

### 电路

![20220419155501-2022-04-19-15-55-03](http://lengyuewusheng-blog.oss-cn-beijing.aliyuncs.com/blog/20220419155501-2022-04-19-15-55-03.png)

### 代码

```
/* 使用可变电位计控制舵机转动 */
 
#include
Servo myservo; // 创建一个 servo object
int potpin = 0; // analog pin 用来连接电位计
int val; // val存储analog pin的值
 
void setup() {
myservo.attach(9); // 连接舵机控制信号（黄或白）至 pin 9
}
 
void loop() {
val = analogRead(potpin);
// 读出可变电位计的值 (范围 0 - 1023)
val = map(val, 0, 1023, 0, 180);
// 按舵机角度进行设置 (范围 0 - 180)
myservo.write(val); //根据val值设置舵机位置
delay(15);
}
```